<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EchoEngBot</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <h1>ðŸ¤– EchoEngBot</h1>

        <div id="chatControls" class="chat-controls">
            <div class="chat-controls__db">
                <button onclick="openKnowledgeModal()">Show Knowledge Base</button>
                <button id="settingsDB" onclick="showSettingsDB()"><span>&#9881</span></button>
            </div>
            <button id="clearHistoryBtn" onclick="clearHistory()">Clear history</button>
        </div>
        <div id="chatHistory" class="chat-history"></div>
        <div class="input-group">
            <input type="text" id="messageInput" placeholder="Enter your phrase...">
            <button class="ask-btn" onclick="askBot()">Ask</button>
        </div>

        <div class="teach-section">
            <span class="teach-section__close" onclick="showSettingsDB()">close</span>
            <button onclick="showModal('teachModal')">Teach the bot</button>
            <button onclick="showModal('editModal')">Edit answer</button>
            <button onclick="showModal('deleteModal')">Delete phrase/answer</button>
            <button onclick="showModal('synonymModal')">Add synonym</button>
            <button onclick="showModal('editSynonymModal')">Edit synonym</button>
            <button onclick="showModal('deleteSynonymModal')">Delete synonym</button>
        </div>
    </div>

    <div id="knowledgeModal" class="modal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeModal('knowledgeModal')">&times;</span>
            <h2>Knowledge Base</h2>
            <input type="text" id="knowledgeSearch" placeholder="Search...">
            <div id="knowledgeList" style="text-align: left; font-size: 14px;"></div>
        </div>
    </div>
    <div id="teachModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('teachModal')">&times;</span>
            <h2>Teach the bot</h2>
            <input type="text" id="teachPhrase" placeholder="Phrase">
            <input type="text" id="teachAnswer" placeholder="Answer">
            <button onclick="teachBot()">Save</button>
            <div id="teachResponse" class="response"></div>
        </div>
    </div>
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editModal')">&times;</span>
            <h2>Edit bot's answer</h2>
            <input type="text" id="editPhrase" placeholder="Phrase">
            <input type="text" id="editOldAnswer" placeholder="Old answer">
            <input type="text" id="editNewAnswer" placeholder="New answer">
            <button onclick="editBotAnswer()">Edit</button>
            <div id="editResponse" class="response"></div>
        </div>
    </div>
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('deleteModal')">&times;</span>
            <h2>Delete from bot</h2>
            <input type="text" id="deletePhrase" placeholder="Phrase">
            <input type="text" id="deleteAnswer" placeholder="(Optional) Specific answer to delete">
            <button onclick="deleteFromBot()">Delete</button>
            <div id="deleteResponse" class="response"></div>
        </div>
    </div>
    <div id="synonymModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('synonymModal')">&times;</span>
            <h2>Add Synonym</h2>
            <input type="text" id="mainPhrase" placeholder="Main phrase">
            <input type="text" id="newSynonym" placeholder="Synonym">
            <button onclick="addSynonym()">Add</button>
            <div id="synonymResponse" class="response"></div>
        </div>
    </div>
    <div id="editSynonymModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editSynonymModal')">&times;</span>
            <h2>Edit Synonym</h2>
            <input type="text" id="editSynMain" placeholder="Main phrase">
            <input type="text" id="editSynOld" placeholder="Old synonym">
            <input type="text" id="editSynNew" placeholder="New synonym">
            <button onclick="editSynonym()">Save</button>
            <div id="editSynResponse" class="response"></div>
        </div>
    </div>
    <div id="deleteSynonymModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('deleteSynonymModal')">&times;</span>
            <h2>Delete Synonym</h2>
            <input type="text" id="deleteSynMain" placeholder="Main phrase">
            <input type="text" id="deleteSynOne" placeholder="(Optional) Synonym to delete">
            <button onclick="deleteSynonym()">Delete</button>
            <div id="deleteSynResponse" class="response"></div>
        </div>
    </div>

    <script>
        const chatHistory = document.getElementById("chatHistory");
        const chatControls = document.getElementById("chatControls");
        let chatData = [];
        let isLearning = false;
        let lastUnknownPhrase = "";

        function getScrollbarWidth() {
            const scrollDiv = document.createElement("div");
            scrollDiv.style.visibility = "hidden";
            scrollDiv.style.overflow = "scroll";
            scrollDiv.style.position = "absolute";
            scrollDiv.style.top = "-9999px";
            scrollDiv.style.width = "100px";
            scrollDiv.style.height = "100px";

            document.body.appendChild(scrollDiv);
            const scrollbarWidth = scrollDiv.offsetWidth - scrollDiv.clientWidth;
            document.body.removeChild(scrollDiv);

            return scrollbarWidth;
        }

        function showSettingsDB() {
            document.querySelector(".teach-section").classList.toggle("open");
        }

        function showModal(id) {
            const modal = document.getElementById(id);
            modal.classList.add("open");
            modal.style.zIndex = "1";
            modal.style.opacity = "1";
            const scrollbarWidth = getScrollbarWidth();
            document.body.style.overflow = "hidden";
            document.body.style.paddingRight = scrollbarWidth + "px";
        }

        function closeModal(id) {
            const modal = document.getElementById(id);    
            modal.classList.remove("open");
            modal.style.opacity = "0";
            modal.style.zIndex = "-1";
            document.body.style.overflow = "auto";
            document.body.style.paddingRight = "";
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target.id);
            }
        }

        function saveHistoryToLocalStorage() {
            localStorage.setItem("chatData", JSON.stringify(chatData));
        }

        function renderChat() {
            chatHistory.innerHTML = "";

            chatData.forEach(entry => {
                const div = document.createElement("div");
                div.className = `chat-entry ${entry.role}`;
                div.innerHTML = `<div class="chat-bubble">${entry.text}</div>`;
                chatHistory.appendChild(div);
            });

            const hasChat = chatData.length > 0;

            chatHistory.style.display = hasChat ? "block" : "none";

            const clearBtn = document.getElementById("clearHistoryBtn");
            if (clearBtn) {
                clearBtn.style.display = hasChat ? "block" : "none";
            }

            chatHistory.scrollTop = chatHistory.scrollHeight;
        }


        function loadHistoryFromLocalStorage() {
            const saved = localStorage.getItem("chatData");
            if(saved) {
                chatData = JSON.parse(saved);
                renderChat();
            }
            renderChat(); 
        }
        window.onload = loadHistoryFromLocalStorage;

        async function openKnowledgeModal() {
            const [phrasesRes, synonymsRes] = await Promise.all([
                fetch("/all-phrases"),
                fetch("/all-synonyms")
            ]);

            const phrasesData = await phrasesRes.json();
            const synonymsData = await synonymsRes.json();

            const db = phrasesData.data;
            const syn = synonymsData.data;

            const allData = Object.keys(db).map(phrase => ({
                phrase,
                answers: db[phrase],
                synonyms: syn[phrase] || []
            }));

            const searchInput = document.getElementById("knowledgeSearch");
            const list = document.getElementById("knowledgeList");

            function renderList(filtered) {
                list.innerHTML = "";

                if (filtered.length === 0) {
                    list.innerHTML = "<p><i>No matches found.</i></p>";
                    return;
                }

                filtered.forEach(item => {
                    const answerList = item.answers.map(ans => `â€“ ${ans}`).join("<br>");
                    const synonymList = item.synonyms.length ? item.synonyms.map(s => `~ ${s}`).join("<br>") : "<i>no synonyms</i>";
                    list.innerHTML += `
                        <div style="margin-bottom: 20px;">
                            <b>${item.phrase}</b><br>
                            <u>Answers:</u><br>${answerList}<br>
                            <u>Synonyms:</u><br>${synonymList}
                        </div>
                    `;
                });
            }

            renderList(allData);

            searchInput.oninput = () => {
                const query = searchInput.value.trim().toLowerCase();
                const filtered = allData.filter(item =>
                    item.phrase.includes(query) ||
                    item.answers.some(ans => ans.toLowerCase().includes(query)) ||
                    item.synonyms.some(s => s.toLowerCase().includes(query))
                );
                renderList(filtered);
            };

            const modal = document.getElementById("knowledgeModal");
            modal.classList.add("open");
            modal.style.zIndex = "1";
            modal.style.opacity = "1";
            const scrollbarWidth = getScrollbarWidth();
            document.body.style.overflow = "hidden";
            document.body.style.paddingRight = scrollbarWidth + "px";
        }

        async function askBot() {
            const input = document.getElementById("messageInput");
            const message = input.value.trim();
            if (!message) return;

            if (isLearning) {
                const teachRes = await fetch("/teach", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ phrase: lastUnknownPhrase, answer: message })
                });
                const data = await teachRes.json();
                chatData.push({ role: "user", text: message });
                chatData.push({ role: "bot", text: "Thanks! I've learned how to answer that." });
                isLearning = false;
                lastUnknownPhrase = "";
                renderChat();
                saveHistoryToLocalStorage();
                input.value = "";
                return;
            }

            const res = await fetch("/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message })
            });
            const data = await res.json();

            chatData.push({ role: "user", text: message });
            chatData.push({ role: "bot", text: data.response });

            if (data.response && data.response.includes("Please teach me")) {
                isLearning = true;
                lastUnknownPhrase = message;
            }

            renderChat();
            saveHistoryToLocalStorage();
            input.value = "";
        }

        function clearHistory() {
            chatData = [];
            chatHistory.innerHTML = "";
            chatHistory.style.display = "none";
            localStorage.removeItem("chatData");
            renderChat();
        }

        async function teachBot() {
            const phrase = document.getElementById("teachPhrase").value;
            const answer = document.getElementById("teachAnswer").value;
            const res = await fetch("/teach", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ phrase, answer })
            });
            const data = await res.json();
            document.getElementById("teachResponse").innerText = data.message;
        }

        async function editBotAnswer() {
            const phrase = document.getElementById("editPhrase").value.trim();
            const oldAnswer = document.getElementById("editOldAnswer").value.trim();
            const newAnswer = document.getElementById("editNewAnswer").value.trim();

            if (!phrase || !oldAnswer || !newAnswer) return;

            const res = await fetch("/edit", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ phrase, old_answer: oldAnswer, new_answer: newAnswer })
            });

            const data = await res.json();
            document.getElementById("editResponse").innerText = data.message;
        }

        async function deleteFromBot() {
            const phrase = document.getElementById("deletePhrase").value.trim();
            const answer = document.getElementById("deleteAnswer").value.trim();
            
            if(!phrase) return;

            const res = await fetch("/delete", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ phrase, answer: answer || null })
            });

            const data = await res.json();
            document.getElementById("deleteResponse").innerText = data.message;
        }

        async function addSynonym() {
            const main = document.getElementById("mainPhrase").value.trim();
            const synonym = document.getElementById("newSynonym").value.trim();

            if (!main || !synonym) return;

            const res = await fetch("/add-synonym", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ main, synonym }) 
            });

            const data = await res.json();
            document.getElementById("synonymResponse").innerText = data.message;
        }

        async function editSynonym() {
            const main = document.getElementById("editSynMain").value.trim();
            const old_syn = document.getElementById("editSynOld").value.trim();
            const new_syn = document.getElementById("editSynNew").value.trim();

            if (!main || !old_syn || !new_syn) return;

            const res = await fetch("/edit-synonym", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ main, old_syn, new_syn })
            });

            const data = await res.json();
            document.getElementById("editSynResponse").innerText = data.message;
        }

        async function deleteSynonym() {
            const main = document.getElementById("deleteSynMain").value.trim();
            const synonym = document.getElementById("deleteSynOne").value.trim();

            if (!main) {
                document.getElementById("deleteSynResponse").innerText = "Please enter the main phrase.";
                return;
            }

            const res = await fetch("/delete-synonym", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ main, synonym })
            })

            const data = await res.json();
            document.getElementById("deleteSynResponce").innerText = data.message;
        }
    </script>
</body>
</html>